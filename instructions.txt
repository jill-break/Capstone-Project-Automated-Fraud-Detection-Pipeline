docker setup
docker run --name capstone-db -e POSTGRES_PASSWORD=mysecretpassword -p 5432:5432 -d postgres

# Wait for the database to initialize
docker exec -it capstone-db psql -U postgres

-- Use the default 'postgres' database
-- 1. Create the table
CREATE TABLE transactions (
    transaction_id SERIAL PRIMARY KEY,
    user_id INT,
    amount DECIMAL(10, 2),
    transaction_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    merchant_category VARCHAR(50)
);

-- 2. Insert Normal Data (User 101 usually spends small amounts)
INSERT INTO transactions (user_id, amount, merchant_category, transaction_date) VALUES 
(101, 45.50, 'Groceries', NOW() - INTERVAL '10 days'),
(101, 52.00, 'Dining', NOW() - INTERVAL '9 days'),
(101, 30.00, 'Transport', NOW() - INTERVAL '8 days'),
(101, 60.25, 'Groceries', NOW() - INTERVAL '7 days'),
(101, 48.75, 'Dining', NOW() - INTERVAL '6 days'),
(101, 55.00, 'Utilities', NOW() - INTERVAL '5 days');

-- 3. Insert the ANOMALY (The Fraud Case for User 101)
-- This value ($5,000) is statistically huge compared to the rows above.
INSERT INTO transactions (user_id, amount, merchant_category, transaction_date) VALUES 
(101, 5000.00, 'Electronics', NOW() - INTERVAL '1 hour');

-- 4. Insert data for another user (User 102 - Normal behavior)
INSERT INTO transactions (user_id, amount, merchant_category, transaction_date) VALUES 
(102, 120.00, 'Retail', NOW() - INTERVAL '3 days'),
(102, 110.00, 'Retail', NOW() - INTERVAL '2 days'),
(102, 130.00, 'Dining', NOW() - INTERVAL '1 day');

-- 5. Verify the inserted data
SELECT * FROM transactions;

-- 6. Query to detect anomalies based on z-score
SELECT
    transaction_id,
    user_id,
    amount,
    transaction_date,
    merchant_category,
    (amount - avg_amount) / stddev_amount AS z_score
FROM (
    SELECT
        transaction_id,
        user_id,
        amount,
        transaction_date,
        merchant_category,
        AVG(amount) OVER (PARTITION BY user_id) AS avg_amount,
        STDDEV_SAMP(amount) OVER (PARTITION BY user_id) AS stddev_amount
    FROM transactions
) t
WHERE stddev_amount IS NOT NULL
  AND stddev_amount <> 0
  AND (amount - avg_amount) / stddev_amount > 2
ORDER BY transaction_date DESC;



-- docker anomalies.csv creation
docker exec -i capstone-db psql -U postgres -d postgres -c "COPY (
    SELECT transaction_id, user_id, amount, transaction_date, merchant_category,
    (amount - AVG(amount) OVER (PARTITION BY user_id)) / STDDEV_SAMP(amount) OVER (PARTITION BY user_id) as z_score
    FROM transactions
) TO STDOUT WITH CSV HEADER" > anomalies.csv

